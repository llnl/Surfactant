<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>capa: identify program capabilities</title>
    <!-- Pyodide is loaded in the worker now -->
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.53/dist/zip.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 2rem; background-color: #f8f9fa; }
        .container { max-width: 1300px; }
        #drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        #drop-zone:hover { border-color: #0d6efd; background-color: #f1f7ff; }
        .results-container {
            position: relative;
            max-width: 78ch;
            margin: 2rem auto;
            display: none;
        }
        .code-actions {
            position: absolute;
            top: 5px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
        }
        .results-container:hover .code-actions {
            opacity: 1;
        }
        #results {
            width: 100%;
            white-space: pre;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.9em;
            max-height: 600px;
            overflow-y: auto;
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .loading { display: none; margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 text-center">capa: identify program capabilities</h1>
        <p class="text-center text-muted">Run <a href="https://github.com/mandiant/capa" target="_blank">capa</a> purely in your browser using Pyodide (WebAssembly).</p>

        <div id="status-card" class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Status</h5>
                <p class="card-text" id="status-text">Initializing Pyodide...</p>
                <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="status-progress" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div id="drop-zone" class="mb-3" onclick="document.getElementById('file-input').click()">
            <h4>Drop a file here or click to select</h4>
            <p class="text-muted">Supports PE, ELF, .NET modules, and shellcode (x86/x64 only)</p>
            <input type="file" id="file-input" style="display: none;">
            <div class="mt-2" onclick="event.stopPropagation()">
                <a href="#" onclick="loadExample(); return false;">Load an example file (memfrob)</a>
            </div>
        </div>

        <div class="row mb-3 justify-content-center">
            <div class="col-md-3">
                <label for="inputFormat" class="form-label">Input Format</label>
                <select class="form-select" id="inputFormat" onchange="runScan()">
                    <option value="auto" selected>Auto</option>
                    <option value="pe">PE</option>
                    <option value="elf">ELF</option>
                    <option value="sc32">Shellcode 32-bit</option>
                    <option value="sc64">Shellcode 64-bit</option>
                    <!--<option value="binexport2">BinExport2</option>-->
                    <!--<option value="freeze">Freeze</option>-->
                </select>
            </div>
            <div class="col-md-3">
                <label for="inputOS" class="form-label">OS</label>
                <select class="form-select" id="inputOS" onchange="runScan()">
                    <option value="auto" selected>Auto</option>
                    <option value="windows">Windows</option>
                    <option value="linux">Linux</option>
                    <option value="macos">macOS</option>
                    <option value="android">Android</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="outputFormat" class="form-label">Output Format</label>
                <select class="form-select" id="outputFormat" onchange="runScan()">
                    <option value="default" selected>Default</option>
                    <option value="verbose">Verbose</option>
                    <option value="vverbose">Very Verbose</option>
                    <option value="json">JSON</option>
                </select>
            </div>
        </div>

        <div class="loading text-center" id="loading-indicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2" id="loading-text">Analyzing program...</p>
        </div>

        <div id="results-container" class="results-container">
            <div class="code-actions">
                <button class="btn btn-sm btn-light border" onclick="copyOutput()" title="Copy to clipboard">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16">
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/>
                    </svg>
                </button>
                <button class="btn btn-sm btn-light border" onclick="downloadOutput()" title="Save as file">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 1-.708.708l3 3z"/>
                    </svg>
                </button>
            </div>
            <div id="results"></div>
        </div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- File Selection Modal -->
        <div class="modal fade" id="fileSelectionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Select file to scan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>The archive contains multiple files. Please select one to analyze:</p>
                <div class="list-group" id="file-list">
                  <!-- Items go here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <footer class="text-center mt-5 text-muted">
            <small>capa version: <span id="capa-version">loading...</span></small>
            <br>
            <small>Source available on <a href="https://github.com/llnl/Surfactant/tree/main/docs/capa" target="_blank">GitHub</a></small>
        </footer>
    </div>

    <script>
        let worker = null;
        let capa_ready = false;
        let currentFileData = null;
        let currentFileName = null;

        async function log(msg, progress = null) {
            console.log(msg);
            document.getElementById('status-text').textContent = msg;
            if (progress !== null) {
                document.getElementById('status-progress').style.width = progress + '%';
            }
        }

        function initWorker() {
            worker = new Worker('worker.js');

            worker.onmessage = function(e) {
                const data = e.data;
                if (data.type === 'progress') {
                    log(data.message, data.progress);
                } else if (data.type === 'ready') {
                    capa_ready = true;
                    log("Ready!", 100);
                    setTimeout(() => {
                        document.getElementById('status-card').style.display = 'none';
                    }, 2000);
                } else if (data.type === 'result') {
                    const results = document.getElementById('results');
                    const resultsContainer = document.getElementById('results-container');
                    const loading = document.getElementById('loading-indicator');

                    results.textContent = data.output;
                    resultsContainer.style.display = 'block';
                    loading.style.display = 'none';
                } else if (data.type === 'error') {
                    const results = document.getElementById('results');
                    const resultsContainer = document.getElementById('results-container');
                    const loading = document.getElementById('loading-indicator');

                    console.error(data.message);
                    results.textContent = "Error: " + data.message;
                    resultsContainer.style.display = 'block';
                    loading.style.display = 'none';
                } else if (data.type === 'version') {
                    document.getElementById('capa-version').textContent = data.version;
                } else if (data.type === 'rules_hash') {
                    localStorage.setItem('capa_rules_hash', data.hash);
                }
            };

            const storedHash = localStorage.getItem('capa_rules_hash');
            worker.postMessage({ type: 'init', rulesHash: storedHash });
        }

        initWorker();

        // Handle file drop
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', (e) => handleFiles(e.target.files), false);

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (!capa_ready) {
                alert("Please wait for capa to initialize.");
                return;
            }
            if (files.length === 0) return;

            const file = files[0];
            const loading = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            const statusText = document.getElementById('loading-text');

            loading.style.display = 'block';
            resultsContainer.style.display = 'none';
            statusText.textContent = `Reading ${file.name}...`;

            try {
                // Read file
                const buffer = await file.arrayBuffer();
                let fileData = buffer;
                let fileName = file.name;

                // Check for Zip magic bytes (PK..)
                let isZip = false;
                if (buffer.byteLength >= 4) {
                     const magic = new DataView(buffer).getUint32(0, false); // Big endian
                     // 0x504B0304 = "PK\x03\x04"
                     if (magic === 0x504B0304) {
                         isZip = true;
                     }
                }

                if (isZip || file.name.toLowerCase().endsWith('.zip')) {
                    statusText.textContent = "Processing zip archive...";
                    try {
                        const blob = new Blob([buffer]);
                        // zip.js global object
                        const reader = new zip.ZipReader(new zip.BlobReader(blob));
                        const entries = await reader.getEntries();

                        // Filter interesting files (no directories, no MacOS metadata)
                        const candidates = entries.filter(e =>
                            !e.directory &&
                            !e.filename.startsWith('__MACOSX') &&
                            !e.filename.split('/').pop().startsWith('._')
                        );

                        if (candidates.length > 0) {
                            let entry = candidates[0];
                            if (candidates.length > 1) {
                                entry = await new Promise((resolve) => {
                                    const modalEl = document.getElementById('fileSelectionModal');
                                    const listEl = document.getElementById('file-list');
                                    const bsModal = new bootstrap.Modal(modalEl);
                                    let selected = null;

                                    listEl.innerHTML = '';
                                    candidates.forEach((c) => {
                                        const btn = document.createElement('button');
                                        btn.className = 'list-group-item list-group-item-action text-truncate';
                                        btn.textContent = c.filename;
                                        btn.title = c.filename; // Tooltip
                                        btn.onclick = () => {
                                            selected = c;
                                            bsModal.hide();
                                        };
                                        listEl.appendChild(btn);
                                    });

                                    modalEl.addEventListener('hidden.bs.modal', () => {
                                        resolve(selected);
                                    }, { once: true });

                                    bsModal.show();
                                });

                                if (!entry) throw new Error("Cancelled by user");
                            }

                            let password = undefined;
                            if (entry.encrypted) {
                                password = prompt(`Enter password for ${entry.filename}:`, "infected");
                                if (password === null) throw new Error("Cancelled by user");
                            }

                            statusText.textContent = `Extracting ${entry.filename}...`;
                            // Extract to Uint8Array
                            fileData = await entry.getData(new zip.Uint8ArrayWriter(), { password: password });
                            fileName = entry.filename;
                        } else {
                            await reader.close();
                            alert("No suitable files found in zip archive.");
                            loading.style.display = 'none';
                            return;
                        }

                        await reader.close();

                    } catch (zipErr) {
                        if (zipErr.message === "Cancelled by user") {
                            loading.style.display = 'none';
                            return;
                        }
                        console.warn("Zip extraction failed:", zipErr);
                        alert(`Failed to extract from zip: ${zipErr.message}`);
                        loading.style.display = 'none';
                        return;
                    }
                }

                currentFileData = fileData;
                currentFileName = fileName;

                // Run scan
                await runScan(true);

            } catch (err) {
                console.error(err);
                alert("Error reading file: " + err.message);
                loading.style.display = 'none';
            }
        }

        async function runScan(isFileNew = false) {
            if (!currentFileData) return;

            const loading = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            const statusText = document.getElementById('loading-text');

            loading.style.display = 'block';
            resultsContainer.style.display = 'none';
            statusText.textContent = `Analyzing ${currentFileName}...`;

            const outputFormat = document.getElementById('outputFormat').value;
            const inputFormat = document.getElementById('inputFormat').value;
            const inputOS = document.getElementById('inputOS').value;

            // If file is "new" (just uploaded), we send the data.
            // If just changing options, we also send data because worker doesn't persist it forever (or simpler: always send)
            // Transfer buffer if possible? No, we might need it for re-scan.
            // Copying is safer.

            worker.postMessage({
                type: 'scan',
                fileData: currentFileData,
                fileName: currentFileName,
                inputFormat: inputFormat,
                inputOS: inputOS,
                outputFormat: outputFormat
            });
        }


        async function loadExample() {
            if (!capa_ready) {
                alert("Please wait for capa to initialize.");
                return;
            }
            const loading = document.getElementById('loading-indicator');
            const statusText = document.getElementById('loading-text');

            loading.style.display = 'block';
            statusText.textContent = "Downloading example file...";

            try {
                // Using memfrob from capa-testfiles via jsdelivr
                const exampleUrl = "https://cdn.jsdelivr.net/gh/mandiant/capa-testfiles@master/055da8e6ccfe5a9380231ea04b850e18.elf_";
                const response = await fetch(exampleUrl);
                if (!response.ok) throw new Error("Failed to fetch example file");

                const blob = await response.blob();
                const file = new File([blob], "memfrob.elf");

                handleFiles([file]);

            } catch (e) {
                console.error(e);
                alert("Error loading example: " + e.message);
                loading.style.display = 'none';
            }
        }

        function copyOutput() {
             const text = document.getElementById('results').textContent;
             navigator.clipboard.writeText(text).then(() => {
                 alert("Copied to clipboard!");
             });
        }

        function downloadOutput() {
            const text = document.getElementById('results').textContent;
            const outputFormat = document.getElementById('outputFormat').value;
            const extension = outputFormat === 'json' ? 'json' : 'txt';
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capa-output.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
